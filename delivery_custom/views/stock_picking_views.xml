<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <!-- Extend the stock picking form to show shipping details -->
  <record id="view_picking_form_inherit_delivery_custom" model="ir.ui.view">
    <field name="name">stock.picking.form.delivery.custom</field>
    <field name="model">stock.picking</field>
    <field name="inherit_id" ref="stock.view_picking_form"/>
    <field name="arch" type="xml">
      <!-- Add header button to create Delivery Bill -->
      <xpath expr="//form/header" position="inside">
        <button name="action_create_vendor_bill" type="object" string="Create Delivery Bill" class="btn-primary" invisible="vendor_bill_count &gt; 0"/>
        <button name="action_track123_get_tracking" type="object" string="Track123" class="btn-secondary" invisible="not tracking_code" context="{'return_action': True}"/>
      </xpath>
      <!-- Insert Shipping Details as the first tab explicitly -->
      <xpath expr="//sheet/notebook/page[1]" position="before">
        <page string="Shipping Details" id="delivery_custom_shipping_details_page">
          <group>
            <group>
              <field name="carrier_partner_id" options="{'no_create_edit': False}"/>
              <field name="shipping_fee"/>
            </group>
            <group string="Tracking">
              <field name="tracking_code"/>
              <field name="tracking_link" widget="url"/>
            </group>
          </group>
          <group string="Track123 Event Information">
            <group>
              <field name="eventTime"/>
              <field name="eventDetail" nolabel="1" colspan="2"/>
            </group>
          </group>
          <group string="Recipient">
            <group>
              <field name="recipient_name"/>
              <field name="recipient_street"/>
              <field name="recipient_street2"/>
            </group>
            <group>
              <field name="recipient_city"/>
              <field name="recipient_state_id"/>
              <field name="recipient_country_id"/>
            </group>
          </group>
        </page>
      </xpath>
      <!-- Add Bills tab after Shipping Details; shown only when there are linked bills -->
      <xpath expr="//sheet/notebook/page[@id='delivery_custom_shipping_details_page']" position="after">
        <page string="Bills" name="vendor_bills_tab" invisible="vendor_bill_count == 0">
          <field name="vendor_bill_ids" options="{'no_create': True, 'no_create_edit': True}">
            <list>
              <field name="name"/>
              <field name="partner_id"/>
              <field name="invoice_date"/>
              <field name="state"/>
              <field name="amount_total"/>
            </list>
          </field>
        </page>
      </xpath>
      <!-- Ensure fields controlling visibility are in the view -->
      <xpath expr="//form/sheet" position="inside">
        <field name="vendor_bill_count" invisible="1"/>
      </xpath>
    </field>
  </record>

</odoo>
