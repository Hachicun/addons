.. image:: https://odoo-community.org/readme-banner-image
   :target: https://odoo-community.org/get-involved?utm_source=readme
   :alt: Odoo Community Association

=======================
Subscription management
=======================

.. 
   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   !! This file is generated by oca-gen-addon-readme !!
   !! changes will be overwritten.                   !!
   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   !! source digest: sha256:ab6023e140886cb5c4fe2d8e969d404ab4a58de4701d6b906c424c9521d1b5d1
   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

.. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
    :target: https://odoo-community.org/page/development-status
    :alt: Beta
.. |badge2| image:: https://img.shields.io/badge/license-AGPL--3-blue.png
    :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
    :alt: License: AGPL-3
.. |badge3| image:: https://img.shields.io/badge/github-OCA%2Fcontract-lightgray.png?logo=github
    :target: https://github.com/OCA/contract/tree/18.0/subscription_oca
    :alt: OCA/contract
.. |badge4| image:: https://img.shields.io/badge/weblate-Translate%20me-F47D42.png
    :target: https://translation.odoo-community.org/projects/contract-18-0/contract-18-0-subscription_oca
    :alt: Translate me on Weblate
.. |badge5| image:: https://img.shields.io/badge/runboat-Try%20me-875A7B.png
    :target: https://runboat.odoo-community.org/builds?repo=OCA/contract&target_branch=18.0
    :alt: Try me on Runboat

|badge1| |badge2| |badge3| |badge4| |badge5|

This module allows creating subscriptions that generate recurring
invoices or orders. It also enables the sale of products that generate
subscriptions.

**Table of contents**

.. contents::
   :local:

Usage
=====

To make a subscription:

1. Go to *Subscriptions > Configuration > Subscription templates*.
2. Create the templates you consider, choosing the billing frequency:
   daily, monthly... and the method of creating the invoice and/or
   order.
3. Go to *Subscription > Subscriptions*.
4. Create a subscription and indicate the start date. When the
   *Subscriptions Management* cron job is executed, the subscription
   will begin and the first invoice will be created if the execution
   date matches the start date. The invoice will also be created when
   the execution date matches the next invoice date. Additionally, you
   can manually change the subscription status and create an invoice by
   using the *Create Invoice* button. This action creates just an
   invoice even if the subscription template has the *Sale Order &
   Invoice* option selected, because the *Invoicing mode* option is
   triggered through the cron job.
5. The cron job will also end the subscription if its end date has been
   reached.

To create subscriptions with the sale of a product:

1. Go to *Subscriptions > Subscriptions > Products*.
2. Create the product and in the sales tab, complete the fields
   *Subscribable product* and *Subscription template*
3. Create a sales order with the product and confirm it.

Customization for Traditional Medicine Business
================================================

Mục tiêu
--------

Module này đã được tùy chỉnh cho mô hình kinh doanh thuốc Đông y với các yêu cầu:

1. **Cảnh báo sắp hết hạn**: Hiển thị cảnh báo 5 ngày trước khi hợp đồng kết thúc để nhân viên có thể chủ động chăm sóc khách hàng.

2. **Gia hạn thủ công**: Cho phép gia hạn subscription ngay cả khi chưa đến hạn, với khả năng gia hạn nhiều chu kỳ cùng lúc (ví dụ: gia hạn 3 tháng).

3. **Tự động tạo SO+Invoice khi gia hạn**: Khi gia hạn N chu kỳ, hệ thống sẽ tự động tạo ngay N Sale Order draft + N Invoice draft với các ngày giao hàng tương ứng trong tương lai:
   - `commitment_date`: Ngày cam kết giao hàng
   - `date_order`: Ngày xác nhận đơn bán
   - `invoice_date`: Ngày hóa đơn

4. **Quản lý giao hàng theo chu kỳ**: Khách hàng có thể đặt trước nhiều chu kỳ (ví dụ: 3 tháng) nhưng thuốc được giao từng tháng một. Hệ thống theo dõi:
   - Tổng số chu kỳ đã đặt
   - Số chu kỳ đã giao
   - Số chu kỳ còn lại
   - Ngày giao hàng tiếp theo

5. **Toggle cron job**: Cho phép bật/tắt tính năng tự động tạo SO+Invoice qua cron job trên từng subscription.

Những gì đã được implement
---------------------------

### 1. Fields mới trong `sale.subscription`

- `auto_generate_invoice`: Boolean - Bật/tắt cron tự động tạo SO+Invoice
- `days_until_expiry`: Integer (computed) - Số ngày còn lại đến khi hết hạn
- `expiring_soon`: Boolean (computed) - Cảnh báo khi còn ≤5 ngày
- `total_periods_ordered`: Integer (computed, stored) - Tổng số chu kỳ đã đặt
- `total_periods_delivered`: Integer (computed, stored) - Số chu kỳ đã giao
- `remaining_periods`: Integer (computed, stored) - Số chu kỳ còn lại
- `next_delivery_date`: Date (computed, stored) - Ngày giao hàng tiếp theo
- `periods_summary_display`: Char (computed) - Text hiển thị tóm tắt chu kỳ

### 2. Wizard gia hạn (`renew.subscription.wizard`)

- Field `renewal_periods`: Số chu kỳ cần gia hạn
- Method `action_renew()`: Xử lý gia hạn và tạo SO+Invoice

### 3. Methods mới trong `sale.subscription`

- `action_renew_subscription()`: Mở wizard gia hạn
- `_extend_subscription_date(periods)`: Kéo dài date của subscription
- `_create_renewal_orders(periods)`: Tạo N SO draft + N Invoice draft với commitment_date tương lai

### 4. Cập nhật methods tạo SO/Invoice

- `_prepare_sale_order()` và `create_sale_order()`: Nhận tham số `commitment_date`
- `_prepare_account_move()` và `create_invoice()`: Nhận tham số `invoice_date`
- Tự động link SO với subscription qua `order_subscription_id`

### 5. Cập nhật cron job

- `cron_subscription_management()`: Chỉ chạy khi `auto_generate_invoice=True`

### 6. Cập nhật Views

- **Form view**: 
  - Button "Renew Subscription"
  - Hiển thị thông tin chu kỳ trong alert box
  - Field `auto_generate_invoice` với help text
  - Field `next_delivery_date` và `days_until_expiry`
  - Page "Đơn hàng" để xem các SO liên quan

- **Kanban view**: 
  - Badge cảnh báo sắp hết hạn (màu vàng, hiển thị số ngày còn lại)
  - Hiển thị tóm tắt chu kỳ

- **List view**: 
  - Thêm columns: Đã đặt, Đã giao, Còn lại, Giao tiếp theo, Còn (ngày)

- **Search view**: 
  - Filter "Expiring Soon (≤5 days)"

### 7. Security & Manifest

- Thêm access rule cho wizard `renew.subscription.wizard`
- Cập nhật `__manifest__.py` để include wizard XML

Lỗi còn tồn tại
----------------

1. **Filter "Expiring Soon" không hoạt động**: 
   - Field `expiring_soon` là computed field không store nên không thể search được
   - **Giải pháp**: Cần thêm `store=True` hoặc sử dụng domain khác dựa trên `days_until_expiry` và `date`

2. **Tree view của sale_order_ids trong form view**:
   - Odoo đang validate các field trong tree view như thể chúng thuộc model cha (`sale.subscription`) thay vì model con (`sale.order`)
   - **Giải pháp**: Đã tạo view riêng `view_sale_order_subscription_tree` nhưng cần kiểm tra lại cách reference

3. **Computed fields có thể cần optimize**:
   - `_compute_periods_summary` phụ thuộc vào nhiều fields, có thể ảnh hưởng performance
   - Cần monitor và optimize nếu cần

Known issues / Roadmap
======================

- Refactor all the onchanges that have business logic to computed
  write-able fields when possible. Keep onchanges only for UI purposes.
- Add tests.
- Fix filter "Expiring Soon" để có thể search được (cần store computed field hoặc dùng domain khác)
- Optimize computed fields nếu cần thiết

Bug Tracker
===========

Bugs are tracked on `GitHub Issues <https://github.com/OCA/contract/issues>`_.
In case of trouble, please check there if your issue has already been reported.
If you spotted it first, help us to smash it by providing a detailed and welcomed
`feedback <https://github.com/OCA/contract/issues/new?body=module:%20subscription_oca%0Aversion:%2018.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.

Do not contact contributors directly about support or help with technical issues.

Credits
=======

Authors
-------

* Domatix
* Onestein

Contributors
------------

- Carlos Martínez <carlos@domatix.com>
- Carolina Ferrer <carolina@domatix.com>
- `Ooops404 <https://www.ooops404.com>`__:

  - Ilyas <irazor147@gmail.com>

- `Sygel <https://www.sygel.es>`__:

  - Harald Panten
  - Valentin Vinagre
  - Alberto Martínez

- Dennis Sluijk <d.sluijk@onestein.nl>

Maintainers
-----------

This module is maintained by the OCA.

.. image:: https://odoo-community.org/logo.png
   :alt: Odoo Community Association
   :target: https://odoo-community.org

OCA, or the Odoo Community Association, is a nonprofit organization whose
mission is to support the collaborative development of Odoo features and
promote its widespread use.

This module is part of the `OCA/contract <https://github.com/OCA/contract/tree/18.0/subscription_oca>`_ project on GitHub.

You are welcome to contribute. To learn how please visit https://odoo-community.org/page/Contribute.
